<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Skarkin'</title>

    <script src="./js/ethers.umd.min.js"></script>
  </head>
  <body>
    <metamask-login></metamask-login>

    <h1>Skarkin'</h1>
    <h2>NFTs</h2>
    <ul id="nfts"></ul>

    <template id="nft">
      <li data-token-id="%TOKEN_CID%">
        <h1>%TITLE%</h1>
        <img src="//localhost:8080/ipfs/%IMAGE_CID%" alt="%DESC%" />
        <p>%DESC%</p>
        <button>Buy</button>
      </li>
    </template>

    <script>
      const CONTRACT_ADDRESS="%CONTRACT_ADDRESS%"
      const provider = new ethers.providers.Web3Provider(window.ethereum)


      function truncateAddress (address) {
        return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`
      }

      setTimeout((e) => {
        let contractAddress

        class MetaMaskLogin extends HTMLElement {
          constructor() {
            super();
            if(window.ethereum) {
              this.attachShadow({mode: 'open'})

              this.addEventListener('click', this.getAccount.bind(this))
              window.ethereum.on('accountsChanged', this.updateButtonAccount.bind(this))
              window.ethereum.on('chainChanged', this.handleChainChange.bind(this))
              window.ethereum.on('message', console.log)

              this.button = document.createElement('button')
              this.updateButtonAccount([window.ethereum.selectedAddress])

              this.shadowRoot.append(this.button)
            }
          }

          async getAccount() {
            try {
              const accounts = await window.ethereum.request({
                method: 'eth_requestAccounts'
              })
              const account = accounts[0]
            } catch (err) {
              console.warn(err.message)
            }
          }

          handleChainChange(chainInfo) {
            console.log(chainInfo)
          }

          updateButtonAccount(accounts) {
            this.button.innerText = "Connect MetaMask"
            this.connected = false

            if(accounts && accounts[0]) {
              this.button.innerText = truncateAddress(accounts[0])
              this.connected = true
            }
          }
        }

        customElements.define('metamask-login', MetaMaskLogin)
      }, 300)
    </script>
  </body>
</html>
